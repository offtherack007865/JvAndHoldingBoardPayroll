-- SQL Server Instance:  smg-sql01
USE [Support]
IF EXISTS (
    SELECT * FROM sysobjects WHERE id = object_id(N'nrc.fn_GetNrcRaceValueGivenAthenaValue') 
    AND xtype IN (N'FN', N'IF', N'TF')
)
    DROP FUNCTION [nrc].[fn_GetNrcRaceValueGivenAthenaValue]
GO

/* -----------------------------------------------------------------------------------------------------------
   Function Name  :  nrc.fn_GetNrcRaceValueGivenAthenaValue
   Business Analyis:
   Project/Process :   
   Description     :  If the inputted Athena Race Value is either blank or does not exist in the RaceCrossWalk table,
                      output Error Message along with the default NRC Value.  The calling procedure will parse the default value
					  from this message.  If the inputted Athena Race does exist in that table, output the corresponding 
					  NrcValue.
                        
   Author          :   Philip Morrison
   Create Date     :   6/13/2025  

   ***********************************************************************************************************
   **         Change History                                                                                **
   ***********************************************************************************************************

   Date       Version    Author             Description
   --------   --------   -----------        ------------
   6/13/2025  1.01.001   Philip Morrison    Created
*/ -----------------------------------------------------------------------------------------------------------                                   


-- create function scalar-valued udf
CREATE FUNCTION [nrc].[fn_GetNrcRaceValueGivenAthenaValue]
(
  @inputAthenaRaceValue [varchar] (100)
) 
RETURNS [nvarchar] (100)
AS
BEGIN
   
DECLARE @returnString [nvarchar](100) = '';

-- If the inputted Race value is blanks, merely put out the default value.

if (LEN(ltrim(rtrim(@inputAthenaRaceValue))) = 0) BEGIN
   SET @returnString = '0000-0';
   RETURN @returnString;
END

DECLARE @existsAthenaValue [varchar] (100) = null;
DECLARE @existsNrcValue [varchar] (100) = null;

-- Look up the inputted Athena value in the RaceCrossWalk table.

SELECT @existsAthenaValue = [AthenaValue]
       ,@existsNrcValue = [NrcValue]
FROM [Nrc].[nrc].[RaceCrossWalk]
WHERE [AthenaValue] = @inputAthenaRaceValue;

-- If the inputted Athena value does not exist, put out the error message with the default value.

IF (@existsAthenaValue IS NULL) BEGIN
   SET @returnString = '0000-0'
   RETURN @returnString;
END

-- If the inputted Athena value does exist in the table, put out the error message with the default value.

SET @returnString = @existsNrcValue;

RETURN @returnString;

END