-- SQL Server Instance:  smg-sql01
IF (@@SERVERNAME <> 'smg-dsdev05')
BEGIN
PRINT 'Invalid SQL Server Connection'
RETURN
END

USE [Utilities];
IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('payroll_jvhold.qy_GetBoardMembersForInputtedDateAndBoardType'))
   DROP PROC [payroll_jvhold].[qy_GetBoardMembersForInputtedDateAndBoardType]
GO
CREATE PROCEDURE [payroll_jvhold].[qy_GetBoardMembersForInputtedDateAndBoardType]
(
  @inputDate [datetime]
  ,@inputBoardType [varchar] (20)
)
/* -----------------------------------------------------------------------------------------------------------
   Procedure Name  :  payroll_jvhold.qy_GetBoardMembersForInputtedDateAndBoardType
   Business Analyis:
   Project/Process :   
   Description     :  Get Board Members for the inputted date and Board Type.
	  
   Author          :  Philip Morrison 
   Create Date     :  11/17/2025

   ***********************************************************************************************************
   **         Change History                                                                                **
   ***********************************************************************************************************

   Date       Version    Author             Description
   --------   --------   -----------        ------------
   11/7/2025  1.01.001   Philip Morrison    Created
*/ -----------------------------------------------------------------------------------------------------------                                   

AS
BEGIN

-- This Instance Declarations


-- Template Declarations
DECLARE @Application            varchar(128) = 'Payroll' 
DECLARE @Version                varchar(25)  = '1.01.001'

DECLARE @ProcessID              int          = 266
DECLARE @Process                varchar(128) = 'JvHold'

DECLARE @BatchOutID             int
DECLARE @BatchDescription       varchar(1000) = @@SERVERNAME + '.' + DB_NAME() + '.' + OBJECT_SCHEMA_NAME(@@ProcID) + '.' + OBJECT_NAME(@@ProcID) + '  - ' + @Version
DECLARE @BatchDetailDescription varchar(1000)
DECLARE @BatchMessage           varchar(MAX)
DECLARE @User                   varchar(128) = SUSER_NAME()

DECLARE @AnticipatedRecordCount int 
DECLARE @ActualRecordCount      int

SET NOCOUNT ON

BEGIN TRY

--  Initialize Batch
    EXEC Admin.Utilities.logs.di_Batch @BatchOutID OUTPUT,  NULL, 'BatchStart', @BatchDescription, @ProcessID, @Process
----------------------------------------------------------------------------------------------------------------------------------------------------
    SET @BatchDetailDescription = '010/010:  Get the Board Members Active as of input date'     
    EXEC Admin.Utilities.logs.di_Batch @BatchOutID OUTPUT,  @BatchOutID, 'DetailStart', @BatchDetailDescription
	
	  SELECT @AnticipatedRecordCount = COUNT(*)
      FROM [CommitteePayroll].[payroll_jvhold].[BoardMemberAssignment] assign
      JOIN [CommitteePayroll].[payroll_jvhold].[BoardMemberContactInfo] contact
      ON contact.[BoardMemberContactInfoID] = assign.[BoardMemberContactInfoID]
      JOIN [CommitteePayroll].[payroll_jvhold].[PayRateForBoardPosition] payrate
      ON payrate.[PayRateForBoardPositionID] = assign.[PayRateForBoardPositionID]
      JOIN [CommitteePayroll].[payroll_jvhold].[BoardType] brdtype
      ON brdtype.[BoardTypeID] = payrate.[BoardTypeID]
      WHERE brdtype.[BoardTypeName] = @inputBoardType
      AND ((assign.[TenureEndDate] IS NOT NULL AND 
              @inputDate BETWEEN assign.[TenureStartDate] AND 
              assign.[TenureEndDate]) OR
          (assign.[TenureEndDate] IS NULL AND 
              @inputDate >= assign.[TenureStartDate]));
	  
      -- Get the Board Members Active as of input date
      SELECT 
        contact.[FirstName]
        , contact.[LastName]
        , contact.[Degree]
	    , contact.[EmailAddress]
	    , payrate.[BoardPosition]
	    , payrate.[PayRate]
		, brdtype.[BoardTypeName]
      FROM [CommitteePayroll].[payroll_jvhold].[BoardMemberAssignment] assign
      JOIN [CommitteePayroll].[payroll_jvhold].[BoardMemberContactInfo] contact
      ON contact.[BoardMemberContactInfoID] = assign.[BoardMemberContactInfoID]
      JOIN [CommitteePayroll].[payroll_jvhold].[PayRateForBoardPosition] payrate
      ON payrate.[PayRateForBoardPositionID] = assign.[PayRateForBoardPositionID]
      JOIN [CommitteePayroll].[payroll_jvhold].[BoardType] brdtype
      ON brdtype.[BoardTypeID] = payrate.[BoardTypeID]
      WHERE brdtype.[BoardTypeName] = @inputBoardType
      AND ((assign.[TenureEndDate] IS NOT NULL AND 
              @inputDate BETWEEN assign.[TenureStartDate] AND 
              assign.[TenureEndDate]) OR
          (assign.[TenureEndDate] IS NULL AND 
              @inputDate >= assign.[TenureStartDate]));
       
    SET @ActualRecordCount = @@ROWCOUNT
    EXEC Admin.Utilities.logs.di_Batch @BatchOutID OUTPUT,  @BatchOutID, 'DetailEnd', NULL, NULL, NULL, @AnticipatedRecordCount, @ActualRecordCount

----------------------------------------------------------------------------------------------------------------------------------------------------

--  Close batch
    EXEC Admin.Utilities.logs.di_batch @BatchOutID OUTPUT, @BatchOutID, 'BatchEnd'

END TRY

BEGIN CATCH
DECLARE @Err              int
     ,  @ErrorMessage     varchar(Max)
     ,  @ErrorLine        varchar(128)
     ,  @Workstation      varchar(128) = @Application
     ,  @Procedure        VARCHAR(500)

    IF ERROR_NUMBER() IS NULL 
      SET @Err =0;
    ELSE
      SET @Err = ERROR_NUMBER();

    SET @ErrorMessage = ERROR_MESSAGE()
    SET @ErrorLine    = 'SP Line Number: ' + CAST(ERROR_LINE() as varchar(10)) 
	SET @Workstation  = HOST_NAME()
    SET @Procedure    = @@SERVERNAME + '.' + DB_NAME() + '.' + OBJECT_SCHEMA_NAME(@@ProcID) + '.' + OBJECT_NAME(@@ProcID) + ' - ' + @ErrorLine + ' - ' + LEFT(@BatchDetailDescription, 7)
    EXEC Admin.Utilities.administration.di_ErrorLog  @Application ,@Process, @Version ,0, @ErrorMessage, @Procedure,  @User , @Workstation

    SET @BatchMessage = 'Process Failed:  ' +  @ErrorMessage
    EXEC Admin.Utilities.logs.di_batch @BatchOutID OUTPUT, @BatchOutID, 'BatchEnd', @BatchMessage
    RAISERROR(@ErrorMessage, 16,1)

END CATCH

END